<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Mapa de Inteligencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        body.toolbar-collapsed #map-container {
            right: 40px;
        }
        
        body.toolbar-collapsed #toolbar {
            width: 40px;
            overflow: hidden;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-content {
            display: none;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            height: auto;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-header h2 {
            font-size: 0.9em;
            margin: 0;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-header small {
            display: none;
        }
        
        body.toolbar-collapsed #status-bar {
            right: 40px;
        }
        
        body.toolbar-collapsed #toggle-toolbar {
            right: 5px;
        }
        
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 300px;
            bottom: 0;
            transition: right 0.3s ease;
        }
        
        #map-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #toolbar {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            transition: width 0.3s ease;
        }
        
        #toggle-toolbar {
            position: fixed;
            top: 10px;
            right: 310px;
            z-index: 1001;
            background: #3498db;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: right 0.3s ease;
        }
        
        #toggle-toolbar:hover {
            background: #2980b9;
        }
        
        .toolbar-header {
            background: #1a252f;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            cursor: pointer;
        }
        
        .toolbar-header h2 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        .toolbar-section {
            padding: 15px;
            border-bottom: 1px solid #34495e;
        }
        
        .toolbar-section h3 {
            font-size: 0.95em;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .tool-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .tool-btn.primary {
            background: #3498db;
            color: white;
        }
        
        .tool-btn.primary:hover {
            background: #2980b9;
        }
        
        .tool-btn.primary.active {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        .tool-btn.secondary {
            background: #7f8c8d;
            color: white;
        }
        
        .tool-btn.secondary:hover {
            background: #6c7a7b;
        }
        
        .tool-btn.danger {
            background: #e74c3c;
            color: white;
        }
        
        .tool-btn.danger:hover {
            background: #c0392b;
        }
        
        .tool-btn.success {
            background: #27ae60;
            color: white;
        }
        
        .tool-btn.success:hover {
            background: #219a52;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            font-size: 0.85em;
            margin-bottom: 5px;
            color: #bdc3c7;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .color-input {
            height: 35px;
            cursor: pointer;
        }
        
        #elementos-lista {
            max-height: 200px;
            overflow-y: auto;
            background: #34495e;
            border-radius: 6px;
            padding: 5px;
        }
        
        .elemento-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 3px 0;
            background: #2c3e50;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .elemento-item .elem-nombre {
            flex: 1;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .elemento-item .elem-nombre:hover {
            background: #34495e;
        }
        
        .elemento-item .elem-actions {
            display: flex;
            gap: 5px;
        }
        
        .elemento-item .action-btn {
            background: #7f8c8d;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
        }
        
        .elemento-item .action-btn.edit-btn:hover {
            background: #3498db;
        }
        
        .elemento-item .action-btn.delete-btn {
            background: #e74c3c;
        }
        
        .elemento-item .action-btn.delete-btn:hover {
            background: #c0392b;
        }
        
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 300px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 10px 20px;
            font-size: 0.9em;
            transition: right 0.3s ease;
        }
        
        .hidden {
            display: none !important;
        }
        
        #instrucciones {
            background: #1a252f;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85em;
            line-height: 1.5;
            color: #bdc3c7;
        }
        
        #modal-rename, #modal-tipo-elemento, #modal-editar-torre {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        #modal-rename.show, #modal-tipo-elemento.show, #modal-editar-torre.show {
            display: flex;
        }
        
        .modal-content {
            background: #2c3e50;
            padding: 25px;
            border-radius: 10px;
            min-width: 350px;
            color: white;
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #3498db;
        }
        
        .modal-content input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 1em;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .modal-buttons .btn-save {
            background: #27ae60;
            color: white;
        }
        
        .modal-buttons .btn-cancel {
            background: #7f8c8d;
            color: white;
        }
        
        .tipo-elemento-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            text-align: left;
            transition: all 0.2s;
        }
        
        .tipo-elemento-btn:hover {
            transform: translateX(5px);
        }
        
        .tipo-torre { background: #e74c3c; color: white; }
        .tipo-encuentro { background: #27ae60; color: white; }
        .tipo-focus { background: #f39c12; color: white; }
        .tipo-normal { background: #3498db; color: white; }
        
        #radio-torre-group {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #34495e;
            border-radius: 6px;
        }
        
        #radio-torre-group label {
            display: block;
            margin-bottom: 5px;
            color: #bdc3c7;
        }
        
        #radio-torre-group input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
        }
        
        .tool-btn.measure {
            background: #9b59b6;
            color: white;
        }
        
        .tool-btn.measure:hover {
            background: #8e44ad;
        }
        
        .tool-btn.measure.active {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        #distance-panel {
            display: none;
            position: fixed;
            top: 180px;
            left: 10px;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        #distance-panel.show {
            display: block;
        }
        
        #distance-panel h4 {
            margin: 0 0 10px 0;
            color: #9b59b6;
        }
        
        #distance-panel .distance-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        #distance-panel .distance-info {
            font-size: 0.85em;
            color: #bdc3c7;
            margin-bottom: 10px;
        }
        
        #modal-exportar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        #modal-exportar.show {
            display: flex;
        }
        
        .export-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            text-align: left;
            transition: all 0.2s;
        }
        
        .export-btn:hover {
            transform: translateX(5px);
        }
        
        .export-kml { background: #3498db; color: white; }
        .export-kmz { background: #27ae60; color: white; }
        
        .icono-select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
        }
        
        .icono-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #34495e;
            border-radius: 6px;
        }
        
        .icono-preview-svg {
            width: 32px;
            height: 32px;
        }
        
        .icono-preview-label {
            color: #bdc3c7;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <button id="toggle-toolbar" onclick="toggleToolbar()" title="Ocultar/Mostrar herramientas">&#10005;</button>
    
    <div id="map-container">
        <iframe id="map-frame" srcdoc="{{ mapa_contenido | e }}"></iframe>
    </div>
    
    <div id="toolbar">
        <div class="toolbar-header" onclick="toggleToolbar()">
            <h2>Editor de Mapa</h2>
            <small>Herramientas de Inteligencia</small>
        </div>
        
        <div class="toolbar-content">
            <div class="toolbar-section">
                <h3>Ir a Coordenadas</h3>
                <div class="input-group">
                    <label>Coordenadas (lat, lon):</label>
                    <input type="text" id="coordenadas-input" placeholder="9.7489, -69.5839">
                </div>
                <button class="tool-btn primary" onclick="irACoordenadas()">
                    Ir a Coordenadas
                </button>
            </div>
            
            <div class="toolbar-section">
                <h3>Herramientas de Dibujo</h3>
                <button class="tool-btn primary" id="btn-ruta" onclick="activarModo('ruta')">
                    Dibujar Ruta
                </button>
                <button class="tool-btn primary" id="btn-etiqueta" onclick="activarModo('etiqueta')">
                    Agregar Etiqueta
                </button>
                <button class="tool-btn primary" id="btn-circulo" onclick="activarModo('circulo')">
                    Agregar Circulo
                </button>
                <button class="tool-btn measure" id="btn-medir" onclick="activarModoMedir()">
                    Medir Distancia
                </button>
            </div>
            
            <div class="toolbar-section">
                <h3>Icono de Etiqueta</h3>
                <div class="input-group">
                    <label>Tipo de marcador:</label>
                    <select id="icono-selector" class="icono-select">
                        <option value="">-- Marcador Normal --</option>
                        <option value="punto_encuentro">Punto de Encuentro</option>
                        <option value="sospechoso">Ubicacion de Sospechoso</option>
                        <option value="escena_crimen">Escena del Crimen</option>
                        <option value="vehiculo">Vehiculo</option>
                        <option value="testigo">Testigo</option>
                        <option value="camara">Camara de Vigilancia</option>
                        <option value="patrulla">Patrulla Policial</option>
                        <option value="victima">Victima</option>
                        <option value="evidencia">Evidencia</option>
                        <option value="punto_control">Punto de Control</option>
                    </select>
                </div>
            </div>
            
            <div class="toolbar-section">
                <h3>Opciones</h3>
                <div class="input-group">
                    <label>Color:</label>
                    <input type="color" id="color-selector" class="color-input" value="#FF0000">
                </div>
                <div class="input-group">
                    <label>Texto/Nombre:</label>
                    <input type="text" id="texto-input" placeholder="Nombre del elemento">
                </div>
                <div class="input-group" id="radio-group">
                    <label>Radio (metros):</label>
                    <input type="number" id="radio-input" value="100" min="10" max="10000">
                </div>
                <div class="input-group" id="grosor-group">
                    <label>Grosor de linea:</label>
                    <input type="number" id="grosor-input" value="3" min="1" max="20">
                </div>
            </div>
            
            <div class="toolbar-section">
                <h3>Acciones</h3>
                <button class="tool-btn secondary" onclick="deshacer()">
                    Deshacer Ultimo
                </button>
                <button class="tool-btn danger" onclick="limpiarTodo()">
                    Limpiar Todo
                </button>
                <button class="tool-btn success" onclick="guardarMapa()">
                    Guardar Mapa
                </button>
                <button class="tool-btn primary" onclick="abrirModalExportar()">
                    Exportar Mapa
                </button>
            </div>
            
            <div class="toolbar-section">
                <h3>Elementos Agregados</h3>
                <div id="elementos-lista"></div>
            </div>
            
            <div class="toolbar-section">
                <div id="instrucciones">
                    <strong>Instrucciones:</strong><br>
                    1. Seleccione una herramienta<br>
                    2. Haga clic en el mapa<br>
                    3. Para rutas: doble clic para terminar<br>
                    4. Click en nombre para renombrar<br>
                    5. Guarde los cambios al finalizar
                </div>
            </div>
        </div>
    </div>
    
    <div id="distance-panel">
        <h4>Medir Distancia</h4>
        <div class="distance-info" id="distance-points">Puntos: 0</div>
        <div class="distance-value" id="distance-display">0 m</div>
        <button class="tool-btn secondary" onclick="limpiarMedicion()" style="padding:8px;margin-top:5px;">Limpiar Medicion</button>
        <button class="tool-btn danger" onclick="cerrarMedicion()" style="padding:8px;margin-top:5px;">Cerrar</button>
    </div>
    
    <div id="status-bar">
        Listo. Seleccione una herramienta para comenzar.
    </div>
    
    <div id="modal-exportar">
        <div class="modal-content">
            <h3>Exportar Mapa</h3>
            <p style="color:#bdc3c7;margin-bottom:15px;">Seleccione el formato de exportacion:</p>
            <button class="export-btn export-kml" onclick="exportarMapa('kml')">
                <strong>KML</strong> - Keyhole Markup Language<br>
                <small>Archivo de texto, compatible con Google Earth</small>
            </button>
            <button class="export-btn export-kmz" onclick="exportarMapa('kmz')">
                <strong>KMZ</strong> - KML Comprimido<br>
                <small>Archivo comprimido, incluye iconos</small>
            </button>
            <button class="export-btn" style="background:#27ae60;color:white;" onclick="exportarRadioBTS()">
                <strong>Excel Radio BTS</strong><br>
                <small>Exportar coordenadas de torres en Excel</small>
            </button>
            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn-cancel" onclick="cerrarModalExportar()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-rename">
        <div class="modal-content">
            <h3>Editar Elemento</h3>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Nombre:</label>
                <input type="text" id="rename-input" placeholder="Nuevo nombre">
            </div>
            <div id="icono-edit-container" style="margin-bottom:10px;display:none;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Tipo de Marcador:</label>
                <select id="icono-edit-selector" style="width:100%;padding:8px;border-radius:5px;border:1px solid #555;background:#34495e;color:white;">
                    <option value="">-- Marcador Normal --</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cerrarModalRename()">Cancelar</button>
                <button class="btn-save" onclick="guardarRename()">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-editar-torre">
        <div class="modal-content">
            <h3>Editar Radio BTS</h3>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Nombre de la Antena:</label>
                <input type="text" id="editar-nombre-torre" placeholder="Nombre de la torre" style="width:100%;padding:8px;border:none;border-radius:4px;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Radio en metros:</label>
                <input type="number" id="editar-radio-torre" min="50" max="10000" style="width:100%;padding:8px;border:none;border-radius:4px;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Color del radio:</label>
                <input type="color" id="editar-color-torre" style="width:100%;height:35px;border:none;border-radius:4px;cursor:pointer;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Grosor de linea:</label>
                <input type="number" id="editar-grosor-torre" min="1" max="10" style="width:100%;padding:8px;border:none;border-radius:4px;">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cerrarModalEditarTorre()">Cancelar</button>
                <button class="btn-save" onclick="guardarEditarTorre()">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-tipo-elemento">
        <div class="modal-content">
            <h3>Seleccione Tipo de Elemento</h3>
            <p style="color:#bdc3c7;margin-bottom:15px;" id="coordenadas-mostrar"></p>
            <button class="tipo-elemento-btn tipo-torre" onclick="seleccionarTipoElemento('torre')">
                Radio BTS
            </button>
            <button class="tipo-elemento-btn tipo-encuentro" onclick="seleccionarTipoElemento('encuentro')">
                Punto de Encuentro
            </button>
            <button class="tipo-elemento-btn tipo-focus" onclick="seleccionarTipoElemento('focus')">
                Focus
            </button>
            <button class="tipo-elemento-btn tipo-normal" onclick="seleccionarTipoElemento('normal')">
                Marcador Normal
            </button>
            <div id="radio-torre-group">
                <div style="margin-bottom:10px;">
                    <label>Nombre de la Radio BTS:</label>
                    <input type="text" id="nombre-torre-input" placeholder="Ej: BTS Central" style="width:100%;padding:8px;border:none;border-radius:4px;margin-top:5px;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>Radio en metros:</label>
                    <input type="number" id="radio-torre-input" value="500" min="50" max="10000" style="width:100%;padding:8px;border:none;border-radius:4px;margin-top:5px;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>Color del radio:</label>
                    <input type="color" id="color-torre-input" value="#e74c3c" style="width:100%;height:35px;border:none;border-radius:4px;margin-top:5px;cursor:pointer;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>Grosor de linea:</label>
                    <input type="number" id="grosor-torre-input" value="2" min="1" max="10" style="width:100%;padding:8px;border:none;border-radius:4px;margin-top:5px;">
                </div>
                <button class="tool-btn success" style="margin-top:10px;" onclick="confirmarTorre()">
                    Agregar Radio BTS
                </button>
            </div>
            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn-cancel" onclick="cerrarModalTipo()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        var modoActual = null;
        var puntosRuta = [];
        var elementosEnMapa = [];
        var mapInstance = null;
        var rutaTemp = null;
        var elementosLayer = null;
        var elementoRenombrando = null;
        var coordenadasPendientes = null;
        var torreEditando = null;
        
        var modoMedir = false;
        var puntosMedicion = [];
        var marcadoresMedicion = [];
        var lineaMedicion = null;
        var medicionLayer = null;
        
        var elementosIniciales = {{ elementos | safe }};
        
        var iconosPoliciales = {
            'punto_encuentro': {
                nombre: 'Punto de Encuentro',
                color: '#27ae60',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><circle cx="12" cy="12" r="10" fill="#27ae60" stroke="white" stroke-width="2"/><path d="M12 6v6l4 2" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>',
                abrev: 'PE'
            },
            'sospechoso': {
                nombre: 'Ubicacion de Sospechoso',
                color: '#e74c3c',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><circle cx="12" cy="8" r="5" fill="#e74c3c" stroke="white" stroke-width="1"/><path d="M12 14c-4 0-7 2-7 5v2h14v-2c0-3-3-5-7-5z" fill="#e74c3c" stroke="white" stroke-width="1"/><text x="12" y="11" text-anchor="middle" fill="white" font-size="6" font-weight="bold">?</text></svg>',
                abrev: 'SO'
            },
            'escena_crimen': {
                nombre: 'Escena del Crimen',
                color: '#c0392b',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="2" y="2" width="20" height="20" rx="2" fill="#c0392b" stroke="white" stroke-width="1"/><path d="M6 6l12 12M18 6L6 18" stroke="yellow" stroke-width="3"/></svg>',
                abrev: 'EC'
            },
            'vehiculo': {
                nombre: 'Vehiculo',
                color: '#3498db',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="2" y="8" width="20" height="8" rx="2" fill="#3498db" stroke="white" stroke-width="1"/><circle cx="6" cy="16" r="2" fill="#333" stroke="white" stroke-width="1"/><circle cx="18" cy="16" r="2" fill="#333" stroke="white" stroke-width="1"/><rect x="4" y="5" width="16" height="5" rx="1" fill="#3498db" stroke="white" stroke-width="1"/></svg>',
                abrev: 'VH'
            },
            'testigo': {
                nombre: 'Testigo',
                color: '#9b59b6',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><circle cx="12" cy="8" r="5" fill="#9b59b6" stroke="white" stroke-width="1"/><path d="M12 14c-4 0-7 2-7 5v2h14v-2c0-3-3-5-7-5z" fill="#9b59b6" stroke="white" stroke-width="1"/><circle cx="12" cy="7" r="3" fill="white"/><circle cx="12" cy="7" r="1.5" fill="#333"/></svg>',
                abrev: 'TG'
            },
            'camara': {
                nombre: 'Camara de Vigilancia',
                color: '#34495e',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="3" y="6" width="14" height="12" rx="2" fill="#34495e" stroke="white" stroke-width="1"/><polygon points="17,9 22,6 22,18 17,15" fill="#34495e" stroke="white" stroke-width="1"/><circle cx="8" cy="12" r="3" fill="#e74c3c" stroke="white" stroke-width="1"/></svg>',
                abrev: 'CV'
            },
            'patrulla': {
                nombre: 'Patrulla Policial',
                color: '#2980b9',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="2" y="10" width="20" height="7" rx="2" fill="#2980b9" stroke="white" stroke-width="1"/><circle cx="6" cy="17" r="2" fill="#333" stroke="white" stroke-width="1"/><circle cx="18" cy="17" r="2" fill="#333" stroke="white" stroke-width="1"/><rect x="4" y="6" width="16" height="5" rx="1" fill="white" stroke="#2980b9" stroke-width="1"/><rect x="9" y="3" width="6" height="3" rx="1" fill="#e74c3c"/><rect x="10" y="3" width="4" height="3" fill="#3498db"/></svg>',
                abrev: 'PP'
            },
            'victima': {
                nombre: 'Victima',
                color: '#e67e22',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><circle cx="12" cy="8" r="5" fill="#e67e22" stroke="white" stroke-width="1"/><path d="M12 14c-4 0-7 2-7 5v2h14v-2c0-3-3-5-7-5z" fill="#e67e22" stroke="white" stroke-width="1"/><path d="M8 6l8 4M8 10l8-4" stroke="white" stroke-width="1.5"/></svg>',
                abrev: 'VI'
            },
            'evidencia': {
                nombre: 'Evidencia',
                color: '#f39c12',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><rect x="4" y="4" width="16" height="16" rx="2" fill="#f39c12" stroke="white" stroke-width="1"/><text x="12" y="16" text-anchor="middle" fill="white" font-size="12" font-weight="bold">E</text><circle cx="18" cy="6" r="3" fill="#e74c3c" stroke="white" stroke-width="1"/></svg>',
                abrev: 'EV'
            },
            'punto_control': {
                nombre: 'Punto de Control',
                color: '#1abc9c',
                svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><polygon points="12,2 22,8 22,16 12,22 2,16 2,8" fill="#1abc9c" stroke="white" stroke-width="1"/><circle cx="12" cy="12" r="4" fill="white"/><path d="M12 8v4l3 2" stroke="#1abc9c" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>',
                abrev: 'PC'
            }
        };
        
        function calcularPuntoFinal(lat, lon, distKm, angulo) {
            var R = 6371, distRad = distKm / R, brngRad = angulo * Math.PI / 180;
            var lat1Rad = lat * Math.PI / 180, lon1Rad = lon * Math.PI / 180;
            var lat2Rad = Math.asin(Math.sin(lat1Rad) * Math.cos(distRad) + Math.cos(lat1Rad) * Math.sin(distRad) * Math.cos(brngRad));
            var lon2Rad = lon1Rad + Math.atan2(Math.sin(brngRad) * Math.sin(distRad) * Math.cos(lat1Rad), Math.cos(distRad) - Math.sin(lat1Rad) * Math.sin(lat2Rad));
            return [lat2Rad * 180 / Math.PI, lon2Rad * 180 / Math.PI];
        }
        
        function dibujarSectoresBTS(L, elementosLayer, lat, lon, radioMetros, color, grosor) {
            var angulos = [180, 300, 60];
            var colores = ['blue', 'green', 'red'];
            var cardinales = {'N': 0, 'E': 90, 'S': 180, 'O': 270};
            var sectoresLayers = [];
            
            var circulo = L.circle([lat, lon], {
                radius: radioMetros,
                color: color,
                fill: true,
                fillOpacity: 0.15,
                weight: grosor
            }).addTo(elementosLayer);
            sectoresLayers.push(circulo);
            
            angulos.forEach(function(angulo, i) {
                var pf = calcularPuntoFinal(lat, lon, radioMetros / 1000, angulo);
                var linea = L.polyline([[lat, lon], pf], {
                    color: colores[i],
                    weight: 2,
                    opacity: 0.8,
                    dashArray: '5, 5'
                }).addTo(elementosLayer);
                sectoresLayers.push(linea);
            });
            
            for (var p in cardinales) {
                var pc = calcularPuntoFinal(lat, lon, (radioMetros * 0.9) / 1000, cardinales[p]);
                var marcador = L.marker(pc, {
                    icon: L.divIcon({
                        className: 'cardinal-label',
                        html: '<div style="font-size:10pt;font-weight:bold;color:black;background:white;padding:2px;border-radius:3px;">' + p + '</div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(elementosLayer);
                sectoresLayers.push(marcador);
            }
            
            return sectoresLayers;
        }
        
        function toggleToolbar() {
            document.body.classList.toggle('toolbar-collapsed');
            var btn = document.getElementById('toggle-toolbar');
            if (document.body.classList.contains('toolbar-collapsed')) {
                btn.style.right = '5px';
                btn.innerHTML = '&#9776;';
            } else {
                btn.style.right = '310px';
                btn.innerHTML = '&#10005;';
            }
        }
        
        document.getElementById('map-frame').onload = function() {
            var iframe = document.getElementById('map-frame');
            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            setTimeout(function() {
                var iframeWindow = iframe.contentWindow;
                for (var key in iframeWindow) {
                    try {
                        if (iframeWindow[key] && iframeWindow[key] instanceof iframeWindow.L.Map) {
                            mapInstance = iframeWindow[key];
                            break;
                        }
                    } catch(e) {}
                }
                
                if (mapInstance) {
                    elementosLayer = iframeWindow.L.layerGroup().addTo(mapInstance);
                    
                    mapInstance.on('click', function(e) {
                        manejarClickMapa(e.latlng);
                    });
                    
                    mapInstance.on('dblclick', function(e) {
                        if (modoActual === 'ruta' && puntosRuta.length >= 2) {
                            finalizarRuta();
                        }
                    });
                    
                    elementosIniciales.forEach(function(elem) {
                        dibujarElementoEnMapa(elem);
                        elementosEnMapa.push(elem);
                    });
                    actualizarListaElementos();
                    
                    hacerControlPlegable(iframeDoc);
                    
                    actualizarStatus('Mapa cargado correctamente.');
                } else {
                    actualizarStatus('Error: No se pudo conectar con el mapa.');
                }
            }, 1000);
        };
        
        function hacerControlPlegable(iframeDoc) {
            function intentar() {
                var controlRadio = iframeDoc.getElementById('control-radio');
                if (controlRadio && !controlRadio.querySelector('.toggle-banner-btn')) {
                    var toggleBtn = iframeDoc.createElement('button');
                    toggleBtn.className = 'toggle-banner-btn';
                    toggleBtn.innerHTML = '&#9650;';
                    toggleBtn.style.cssText = 'background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;margin-left:15px;font-size:0.8em;';
                    toggleBtn.title = 'Ocultar/Mostrar panel';
                    
                    var elementosOcultar = [];
                    Array.from(controlRadio.children).forEach(function(child) {
                        if (child.tagName !== 'H3') {
                            elementosOcultar.push(child);
                        }
                    });
                    
                    toggleBtn.onclick = function() {
                        var isCollapsed = controlRadio.getAttribute('data-collapsed') === 'true';
                        if (isCollapsed) {
                            controlRadio.style.padding = '10px 20px';
                            elementosOcultar.forEach(function(child) {
                                child.style.display = '';
                            });
                            toggleBtn.innerHTML = '&#9650;';
                            controlRadio.setAttribute('data-collapsed', 'false');
                        } else {
                            controlRadio.style.padding = '5px 15px';
                            elementosOcultar.forEach(function(child) {
                                child.style.display = 'none';
                            });
                            toggleBtn.innerHTML = '&#9660;';
                            controlRadio.setAttribute('data-collapsed', 'true');
                        }
                    };
                    controlRadio.appendChild(toggleBtn);
                } else if (!controlRadio) {
                    setTimeout(intentar, 500);
                }
            }
            intentar();
        }
        
        function activarModo(modo) {
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
            
            if (modoActual === modo) {
                modoActual = null;
                actualizarStatus('Modo cancelado.');
                return;
            }
            
            modoActual = modo;
            puntosRuta = [];
            
            document.getElementById('btn-' + modo).classList.add('active');
            
            if (modo === 'ruta') {
                actualizarStatus('Modo RUTA: Haga clic para agregar puntos. Doble clic para finalizar.');
            } else if (modo === 'etiqueta') {
                actualizarStatus('Modo ETIQUETA: Haga clic donde desea colocar la etiqueta.');
            } else if (modo === 'circulo') {
                actualizarStatus('Modo CIRCULO: Haga clic para colocar el centro del circulo.');
            }
        }
        
        function cancelarModo() {
            modoActual = null;
            puntosRuta = [];
            if (rutaTemp) {
                elementosLayer.removeLayer(rutaTemp);
                rutaTemp = null;
            }
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
            actualizarStatus('Modo cancelado.');
        }
        
        function manejarClickMapa(latlng) {
            if (!modoActual || !mapInstance) return;
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            if (modoActual === 'ruta') {
                puntosRuta.push([latlng.lat, latlng.lng]);
                
                if (rutaTemp) {
                    elementosLayer.removeLayer(rutaTemp);
                }
                
                var color = document.getElementById('color-selector').value;
                var grosor = parseInt(document.getElementById('grosor-input').value);
                
                rutaTemp = L.polyline(puntosRuta, {
                    color: color,
                    weight: grosor,
                    dashArray: '5, 10'
                }).addTo(elementosLayer);
                
                actualizarStatus('Ruta: ' + puntosRuta.length + ' puntos. Doble clic para finalizar.');
                
            } else if (modoActual === 'etiqueta') {
                agregarEtiqueta(latlng.lat, latlng.lng);
                
            } else if (modoActual === 'circulo') {
                agregarCirculo(latlng.lat, latlng.lng);
            }
        }
        
        function finalizarRuta() {
            if (puntosRuta.length < 2) {
                actualizarStatus('La ruta debe tener al menos 2 puntos.');
                return;
            }
            
            var color = document.getElementById('color-selector').value;
            var grosor = parseInt(document.getElementById('grosor-input').value);
            var nombre = document.getElementById('texto-input').value || 'Ruta ' + (elementosEnMapa.length + 1);
            
            fetch('/api/agregar-ruta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    puntos: puntosRuta,
                    color: color,
                    grosor: grosor,
                    nombre: nombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (rutaTemp) {
                        elementosLayer.removeLayer(rutaTemp);
                        rutaTemp = null;
                    }
                    dibujarElementoEnMapa(data.elemento);
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus('Ruta agregada: ' + nombre);
                }
            });
            
            puntosRuta = [];
            modoActual = null;
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
        }
        
        function agregarEtiqueta(lat, lon) {
            var texto = document.getElementById('texto-input').value || '';
            var tipoIcono = document.getElementById('icono-selector').value;
            var iconoInfo = tipoIcono ? iconosPoliciales[tipoIcono] : null;
            
            if (!texto) {
                texto = iconoInfo ? iconoInfo.nombre : 'Etiqueta';
            }
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            var marker;
            if (iconoInfo) {
                var icono = L.divIcon({
                    className: 'policia-marker',
                    html: '<div style="background:white;border-radius:50%;padding:3px;box-shadow:0 2px 5px rgba(0,0,0,0.3);">' + iconoInfo.svg + '</div>',
                    iconSize: [34, 34],
                    iconAnchor: [17, 17]
                });
                marker = L.marker([lat, lon], {icon: icono}).addTo(elementosLayer);
                marker.bindPopup('<b>' + texto + '</b><br>Tipo: ' + iconoInfo.nombre + '<br>Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
            } else {
                marker = L.marker([lat, lon]).addTo(elementosLayer);
                marker.bindPopup('<b>' + texto + '</b><br>Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
            }
            
            fetch('/api/agregar-etiqueta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    texto: texto,
                    color: iconoInfo ? iconoInfo.color : '#3498db',
                    icono: tipoIcono
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.elemento._layer = marker;
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus((iconoInfo ? iconoInfo.nombre : 'Etiqueta') + ' agregado: ' + texto);
                }
            });
            
            modoActual = null;
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
        }
        
        function agregarCirculo(lat, lon) {
            var radio = parseInt(document.getElementById('radio-input').value);
            var color = document.getElementById('color-selector').value;
            var nombre = document.getElementById('texto-input').value || 'Circulo';
            
            fetch('/api/agregar-circulo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    radio: radio,
                    color: color,
                    nombre: nombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dibujarElementoEnMapa(data.elemento);
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus('Circulo agregado: ' + nombre);
                }
            });
            
            modoActual = null;
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
        }
        
        function dibujarElementoEnMapa(elemento) {
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            var layer = null;
            
            if (elemento.tipo === 'ruta') {
                layer = L.polyline(elemento.puntos, {
                    color: elemento.color,
                    weight: elemento.grosor
                }).addTo(elementosLayer);
                layer.bindPopup('<b>' + elemento.nombre + '</b><br><button onclick="window.parent.eliminarRutaDesdePopup(' + elemento.id + ')" style="background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;margin-top:5px;width:100%;">Eliminar Ruta</button>');
                
                layer.on('dblclick', function(e) {
                    L.DomEvent.stopPropagation(e);
                    layer.openPopup();
                });
                
            } else if (elemento.tipo === 'etiqueta') {
                var tipoIcono = elemento.icono || '';
                var iconoInfo = tipoIcono ? iconosPoliciales[tipoIcono] : null;
                
                if (tipoIcono && tipoIcono.startsWith('data:image')) {
                    var icono = L.icon({
                        iconUrl: tipoIcono,
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    });
                    layer = L.marker([elemento.lat, elemento.lon], {icon: icono}).addTo(elementosLayer);
                    var popupContent = '<b>' + elemento.texto + '</b>';
                    if (elemento.descripcion) {
                        popupContent += '<br>' + elemento.descripcion;
                    }
                    layer.bindPopup(popupContent);
                } else if (iconoInfo) {
                    var icono = L.divIcon({
                        className: 'policia-marker',
                        html: '<div style="background:white;border-radius:50%;padding:3px;box-shadow:0 2px 5px rgba(0,0,0,0.3);">' + iconoInfo.svg + '</div>',
                        iconSize: [34, 34],
                        iconAnchor: [17, 17]
                    });
                    layer = L.marker([elemento.lat, elemento.lon], {icon: icono}).addTo(elementosLayer);
                    layer.bindPopup('<b>' + elemento.texto + '</b><br>Tipo: ' + iconoInfo.nombre);
                } else {
                    layer = L.marker([elemento.lat, elemento.lon]).addTo(elementosLayer);
                    layer.bindPopup('<b>' + elemento.texto + '</b>');
                }
                
            } else if (elemento.tipo === 'torre') {
                var color = elemento.color || '#e74c3c';
                var grosor = elemento.grosor || 2;
                
                var iconoSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="' + color + '" stroke="white" stroke-width="1" d="M12 2L8 10h3v10h2V10h3L12 2z"/><circle cx="12" cy="5" r="2" fill="white"/><path fill="none" stroke="' + color + '" stroke-width="2" d="M6 8c0-3 2.5-5 6-5s6 2 6 5"/><path fill="none" stroke="' + color + '" stroke-width="2" d="M4 10c0-4 3.5-7 8-7s8 3 8 7"/></svg>';
                var icono = L.divIcon({
                    className: 'bts-marker',
                    html: '<div style="background:white;border-radius:50%;padding:2px;box-shadow:0 2px 5px rgba(0,0,0,0.3);">' + iconoSvg + '</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });
                
                var marker = L.marker([elemento.lat, elemento.lon], {icon: icono}).addTo(elementosLayer);
                marker.bindPopup('<b>' + elemento.nombre + '</b><br>Radio: ' + elemento.radio + 'm');
                elemento._marker = marker;
                
                var sectoresLayers = dibujarSectoresBTS(L, elementosLayer, elemento.lat, elemento.lon, elemento.radio, color, grosor);
                elemento._sectores = sectoresLayers;
                layer = sectoresLayers[0];
                
            } else if (elemento.tipo === 'circulo') {
                layer = L.circle([elemento.lat, elemento.lon], {
                    radius: elemento.radio,
                    color: elemento.color,
                    fillOpacity: 0.2
                }).addTo(elementosLayer);
                layer.bindPopup(elemento.nombre);
            }
            
            if (layer) {
                elemento._layer = layer;
            }
        }
        
        function eliminarElemento(id) {
            fetch('/api/eliminar-elemento/' + id, {method: 'DELETE'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var elem = elementosEnMapa.find(e => e.id === id);
                    if (elem) {
                        if (elem._sectores) {
                            elem._sectores.forEach(function(layer) {
                                elementosLayer.removeLayer(layer);
                            });
                        }
                        if (elem._layer) {
                            elementosLayer.removeLayer(elem._layer);
                        }
                        if (elem._marker) {
                            elementosLayer.removeLayer(elem._marker);
                        }
                    }
                    elementosEnMapa = elementosEnMapa.filter(e => e.id !== id);
                    actualizarListaElementos();
                    actualizarStatus('Elemento eliminado.');
                }
            });
        }
        
        function eliminarRutaDesdePopup(id) {
            if (confirm('Esta seguro de eliminar esta ruta?')) {
                eliminarElemento(id);
            }
        }
        
        window.eliminarRutaDesdePopup = eliminarRutaDesdePopup;
        
        function abrirModalRename(id) {
            var elem = elementosEnMapa.find(e => e.id === id);
            if (!elem) return;
            
            elementoRenombrando = elem;
            var nombreActual = elem.nombre || elem.texto || '';
            document.getElementById('rename-input').value = nombreActual;
            
            var iconoContainer = document.getElementById('icono-edit-container');
            var iconoSelect = document.getElementById('icono-edit-selector');
            
            if (elem.tipo === 'etiqueta') {
                iconoSelect.innerHTML = '<option value="">-- Marcador Normal --</option>';
                for (var key in iconosPoliciales) {
                    var opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = iconosPoliciales[key].nombre;
                    iconoSelect.appendChild(opt);
                }
                iconoSelect.value = elem.icono || '';
                iconoContainer.style.display = 'block';
            } else {
                iconoContainer.style.display = 'none';
            }
            
            document.getElementById('modal-rename').classList.add('show');
            document.getElementById('rename-input').focus();
        }
        
        function cerrarModalRename() {
            document.getElementById('modal-rename').classList.remove('show');
            elementoRenombrando = null;
        }
        
        function guardarRename() {
            if (!elementoRenombrando) return;
            
            var nuevoNombre = document.getElementById('rename-input').value.trim();
            if (!nuevoNombre) {
                alert('El nombre no puede estar vacio');
                return;
            }
            
            var elemId = elementoRenombrando.id;
            var nuevoIcono = null;
            var iconoCambio = false;
            
            if (elementoRenombrando.tipo === 'etiqueta') {
                nuevoIcono = document.getElementById('icono-edit-selector').value;
                iconoCambio = (nuevoIcono !== (elementoRenombrando.icono || ''));
            }
            
            var bodyData = {
                nombre: nuevoNombre,
                texto: nuevoNombre
            };
            
            if (elementoRenombrando.tipo === 'etiqueta') {
                bodyData.icono = nuevoIcono;
            }
            
            fetch('/api/actualizar-elemento/' + elemId, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bodyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var elem = elementosEnMapa.find(e => e.id === elemId);
                    if (elem) {
                        if (elem.tipo === 'etiqueta') {
                            elem.texto = nuevoNombre;
                            elem.icono = nuevoIcono;
                            
                            if (iconoCambio && elem._layer) {
                                var iframe = document.getElementById('map-frame');
                                var L = iframe.contentWindow.L;
                                var elementosLayer = iframe.contentWindow.elementosLayer;
                                
                                elementosLayer.removeLayer(elem._layer);
                                dibujarElementoEnMapa(elem);
                            } else if (elem._layer) {
                                var iconoInfo = nuevoIcono ? iconosPoliciales[nuevoIcono] : null;
                                var popupText = iconoInfo ? '<b>' + nuevoNombre + '</b><br>Tipo: ' + iconoInfo.nombre : nuevoNombre;
                                elem._layer.setPopupContent(popupText);
                            }
                        } else {
                            elem.nombre = nuevoNombre;
                            if (elem._layer && elem._layer.getPopup()) {
                                elem._layer.setPopupContent(nuevoNombre);
                            } else if (elem._layer) {
                                elem._layer.bindPopup(nuevoNombre);
                            }
                        }
                    }
                    
                    actualizarListaElementos();
                    actualizarStatus('Elemento actualizado: ' + nuevoNombre);
                    cerrarModalRename();
                } else {
                    alert('Error al actualizar: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(function(err) {
                alert('Error de conexion');
            });
        }
        
        document.getElementById('rename-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                guardarRename();
            }
        });
        
        function deshacer() {
            fetch('/api/deshacer', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var ultimo = elementosEnMapa.pop();
                    if (ultimo && ultimo._layer) {
                        elementosLayer.removeLayer(ultimo._layer);
                    }
                    actualizarListaElementos();
                    actualizarStatus('Ultimo elemento eliminado.');
                } else {
                    actualizarStatus('No hay elementos para deshacer.');
                }
            });
        }
        
        function limpiarTodo() {
            if (!confirm('Esta seguro de limpiar todos los elementos agregados?')) return;
            
            fetch('/api/limpiar', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    elementosLayer.clearLayers();
                    elementosEnMapa = [];
                    actualizarListaElementos();
                    actualizarStatus('Todos los elementos eliminados.');
                }
            });
        }
        
        function guardarMapa() {
            actualizarStatus('Guardando mapa...');
            
            fetch('/api/guardar', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarStatus(data.mensaje);
                    alert('Mapa guardado como: ' + data.archivo);
                } else {
                    actualizarStatus('Error al guardar: ' + data.mensaje);
                }
            });
        }
        
        function actualizarListaElementos() {
            var lista = document.getElementById('elementos-lista');
            if (elementosEnMapa.length === 0) {
                lista.innerHTML = '<div style="padding:10px;text-align:center;color:#7f8c8d;">Sin elementos</div>';
                return;
            }
            
            var html = '';
            elementosEnMapa.forEach(function(elem) {
                var icono = '?';
                if (elem.tipo === 'ruta') {
                    icono = '~';
                } else if (elem.tipo === 'etiqueta') {
                    var tipoIcono = elem.icono || 'punto_encuentro';
                    var iconoInfo = iconosPoliciales[tipoIcono];
                    icono = iconoInfo ? iconoInfo.abrev : 'ET';
                } else if (elem.tipo === 'torre') {
                    icono = 'BTS';
                } else if (elem.tipo === 'circulo') {
                    icono = 'O';
                }
                var nombre = elem.nombre || elem.texto || 'Elemento';
                var editarFunc = elem.tipo === 'torre' ? 'abrirModalEditarTorre(' + elem.id + ')' : 'abrirModalRename(' + elem.id + ')';
                var oculto = elem._oculto ? true : false;
                var ojoIcono = oculto ? '&#128065;&#8211;' : '&#128065;';
                var ojoTitle = oculto ? 'Mostrar' : 'Ocultar';
                var opacidad = oculto ? 'opacity:0.5;' : '';
                html += '<div class="elemento-item" style="' + opacidad + '">' +
                    '<span class="elem-nombre" onclick="' + editarFunc + '" title="Click para editar">[' + icono + '] ' + nombre + '</span>' +
                    '<div class="elem-actions">' +
                    '<button class="action-btn visibility-btn" onclick="toggleVisibilidad(' + elem.id + ')" title="' + ojoTitle + '" style="font-size:12px;">' + ojoIcono + '</button>' +
                    '<button class="action-btn edit-btn" onclick="' + editarFunc + '" title="Editar">&#9998;</button>' +
                    '<button class="action-btn delete-btn" onclick="eliminarElemento(' + elem.id + ')" title="Eliminar">X</button>' +
                    '</div></div>';
            });
            lista.innerHTML = html;
        }
        
        function toggleVisibilidad(id) {
            var elem = elementosEnMapa.find(e => e.id === id);
            if (!elem) return;
            
            elem._oculto = !elem._oculto;
            
            if (elem._oculto) {
                if (elem._sectores) {
                    elem._sectores.forEach(function(layer) {
                        elementosLayer.removeLayer(layer);
                    });
                }
                if (elem._layer) {
                    elementosLayer.removeLayer(elem._layer);
                }
                if (elem._marker) {
                    elementosLayer.removeLayer(elem._marker);
                }
            } else {
                dibujarElementoEnMapa(elem);
            }
            
            actualizarListaElementos();
        }
        
        function actualizarStatus(mensaje) {
            document.getElementById('status-bar').textContent = mensaje;
        }
        
        function irACoordenadas() {
            var input = document.getElementById('coordenadas-input').value.trim();
            if (!input) {
                alert('Por favor ingrese las coordenadas');
                return;
            }
            
            var partes = input.split(',');
            if (partes.length !== 2) {
                alert('Formato invalido. Use: latitud, longitud (ej: 9.7489, -69.5839)');
                return;
            }
            
            var lat = parseFloat(partes[0].trim());
            var lon = parseFloat(partes[1].trim());
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Coordenadas invalidas. Use numeros validos.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Coordenadas fuera de rango. Latitud: -90 a 90, Longitud: -180 a 180');
                return;
            }
            
            coordenadasPendientes = {lat: lat, lon: lon};
            
            if (mapInstance) {
                mapInstance.setView([lat, lon], 16);
            }
            
            document.getElementById('coordenadas-mostrar').textContent = 'Coordenadas: ' + lat.toFixed(6) + ', ' + lon.toFixed(6);
            document.getElementById('radio-torre-group').style.display = 'none';
            document.getElementById('modal-tipo-elemento').classList.add('show');
        }
        
        function cerrarModalTipo() {
            document.getElementById('modal-tipo-elemento').classList.remove('show');
            document.getElementById('radio-torre-group').style.display = 'none';
            coordenadasPendientes = null;
        }
        
        function seleccionarTipoElemento(tipo) {
            if (!coordenadasPendientes) return;
            
            if (tipo === 'torre') {
                document.getElementById('radio-torre-group').style.display = 'block';
                return;
            }
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            var lat = coordenadasPendientes.lat;
            var lon = coordenadasPendientes.lon;
            var nombre = '';
            var color = '';
            var icono = null;
            
            if (tipo === 'encuentro') {
                nombre = 'Punto de Encuentro';
                color = '#27ae60';
                icono = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#27ae60;color:white;padding:5px 10px;border-radius:50%;font-weight:bold;font-size:16px;text-align:center;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">PE</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            } else if (tipo === 'focus') {
                nombre = 'Focus';
                color = '#f39c12';
                icono = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#f39c12;color:white;padding:5px 10px;border-radius:50%;font-weight:bold;font-size:16px;text-align:center;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">F</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            } else {
                nombre = 'Marcador';
                color = '#3498db';
            }
            
            var marker;
            if (icono) {
                marker = L.marker([lat, lon], {icon: icono}).addTo(elementosLayer);
            } else {
                marker = L.marker([lat, lon]).addTo(elementosLayer);
            }
            marker.bindPopup('<b>' + nombre + '</b><br>Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
            
            fetch('/api/agregar-etiqueta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    texto: nombre,
                    color: color
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.elemento._layer = marker;
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus(nombre + ' agregado en: ' + lat.toFixed(4) + ', ' + lon.toFixed(4));
                }
            });
            
            cerrarModalTipo();
        }
        
        function confirmarTorre() {
            if (!coordenadasPendientes) return;
            
            var nombre = document.getElementById('nombre-torre-input').value.trim() || 'Radio BTS';
            var radio = parseInt(document.getElementById('radio-torre-input').value);
            var color = document.getElementById('color-torre-input').value;
            var grosor = parseInt(document.getElementById('grosor-torre-input').value) || 2;
            
            if (isNaN(radio) || radio < 50 || radio > 10000) {
                alert('Radio invalido. Use un valor entre 50 y 10000 metros.');
                return;
            }
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            var lat = coordenadasPendientes.lat;
            var lon = coordenadasPendientes.lon;
            
            var iconoSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="' + color + '" stroke="white" stroke-width="1" d="M12 2L8 10h3v10h2V10h3L12 2z"/><circle cx="12" cy="5" r="2" fill="white"/><path fill="none" stroke="' + color + '" stroke-width="2" d="M6 8c0-3 2.5-5 6-5s6 2 6 5"/><path fill="none" stroke="' + color + '" stroke-width="2" d="M4 10c0-4 3.5-7 8-7s8 3 8 7"/></svg>';
            var icono = L.divIcon({
                className: 'bts-marker',
                html: '<div style="background:white;border-radius:50%;padding:2px;box-shadow:0 2px 5px rgba(0,0,0,0.3);">' + iconoSvg + '</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            var marker = L.marker([lat, lon], {icon: icono}).addTo(elementosLayer);
            marker.bindPopup('<b>' + nombre + '</b><br>Radio: ' + radio + 'm<br>Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
            
            var sectoresLayers = dibujarSectoresBTS(L, elementosLayer, lat, lon, radio, color, grosor);
            
            fetch('/api/agregar-torre', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    radio: radio,
                    color: color,
                    grosor: grosor,
                    nombre: nombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.elemento._layer = sectoresLayers[0];
                    data.elemento._sectores = sectoresLayers;
                    data.elemento._marker = marker;
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus(nombre + ' agregada con radio de ' + radio + 'm');
                }
            });
            
            document.getElementById('nombre-torre-input').value = '';
            cerrarModalTipo();
        }
        
        function abrirModalEditarTorre(id) {
            var elem = elementosEnMapa.find(e => e.id === id);
            if (!elem || elem.tipo !== 'torre') {
                abrirModalRename(id);
                return;
            }
            
            torreEditando = elem;
            document.getElementById('editar-nombre-torre').value = elem.nombre || 'Radio BTS';
            document.getElementById('editar-radio-torre').value = elem.radio || 500;
            document.getElementById('editar-color-torre').value = elem.color || '#e74c3c';
            document.getElementById('editar-grosor-torre').value = elem.grosor || 2;
            document.getElementById('modal-editar-torre').classList.add('show');
            document.getElementById('editar-nombre-torre').focus();
        }
        
        function cerrarModalEditarTorre() {
            document.getElementById('modal-editar-torre').classList.remove('show');
            torreEditando = null;
        }
        
        function guardarEditarTorre() {
            if (!torreEditando) return;
            
            var nombre = document.getElementById('editar-nombre-torre').value.trim();
            var radio = parseInt(document.getElementById('editar-radio-torre').value);
            var color = document.getElementById('editar-color-torre').value;
            var grosor = parseInt(document.getElementById('editar-grosor-torre').value);
            
            if (!nombre) {
                alert('El nombre no puede estar vacio');
                return;
            }
            
            if (isNaN(radio) || radio < 50 || radio > 10000) {
                alert('Radio invalido. Use un valor entre 50 y 10000 metros.');
                return;
            }
            
            if (isNaN(grosor) || grosor < 1 || grosor > 10) {
                grosor = 2;
            }
            
            var elemId = torreEditando.id;
            
            fetch('/api/actualizar-torre/' + elemId, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nombre: nombre,
                    radio: radio,
                    color: color,
                    grosor: grosor
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var elem = elementosEnMapa.find(e => e.id === elemId);
                    if (elem) {
                        if (elem._sectores) {
                            elem._sectores.forEach(function(layer) {
                                elementosLayer.removeLayer(layer);
                            });
                        }
                        if (elem._layer) {
                            elementosLayer.removeLayer(elem._layer);
                        }
                        if (elem._marker) {
                            elementosLayer.removeLayer(elem._marker);
                        }
                        
                        elem.nombre = nombre;
                        elem.radio = radio;
                        elem.color = color;
                        elem.grosor = grosor;
                        
                        dibujarElementoEnMapa(elem);
                    }
                    
                    actualizarListaElementos();
                    actualizarStatus('Radio BTS actualizada: ' + nombre);
                    cerrarModalEditarTorre();
                } else {
                    alert('Error al actualizar: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(function(err) {
                alert('Error de conexion');
            });
        }
        
        document.getElementById('editar-nombre-torre').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                guardarEditarTorre();
            }
        });
        
        function activarModoMedir() {
            if (modoMedir) {
                cerrarMedicion();
                return;
            }
            
            cancelarModo();
            modoMedir = true;
            document.getElementById('btn-medir').classList.add('active');
            document.getElementById('distance-panel').classList.add('show');
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            if (!medicionLayer) {
                medicionLayer = L.layerGroup().addTo(mapInstance);
            }
            
            if (mapInstance) {
                var panes = mapInstance.getPanes();
                if (panes.markerPane) {
                    panes.markerPane.style.pointerEvents = 'none';
                }
                if (panes.overlayPane) {
                    panes.overlayPane.style.pointerEvents = 'none';
                }
                if (panes.shadowPane) {
                    panes.shadowPane.style.pointerEvents = 'none';
                }
                if (panes.popupPane) {
                    panes.popupPane.style.pointerEvents = 'none';
                }
                if (panes.tooltipPane) {
                    panes.tooltipPane.style.pointerEvents = 'none';
                }
            }
            
            actualizarStatus('Modo MEDIR: Haga clic en el mapa para marcar puntos. La distancia se calcula automaticamente.');
        }
        
        function calcularDistanciaTotal() {
            if (puntosMedicion.length < 2) return 0;
            
            var distanciaTotal = 0;
            for (var i = 1; i < puntosMedicion.length; i++) {
                var p1 = puntosMedicion[i - 1];
                var p2 = puntosMedicion[i];
                distanciaTotal += calcularDistanciaHaversine(p1.lat, p1.lng, p2.lat, p2.lng);
            }
            return distanciaTotal;
        }
        
        function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
            var R = 6371000;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        
        function actualizarPanelDistancia() {
            var distancia = calcularDistanciaTotal();
            var displayText = '';
            
            if (distancia >= 1000) {
                displayText = (distancia / 1000).toFixed(2) + ' km';
            } else {
                displayText = distancia.toFixed(1) + ' m';
            }
            
            document.getElementById('distance-display').textContent = displayText;
            document.getElementById('distance-points').textContent = 'Puntos: ' + puntosMedicion.length;
        }
        
        function agregarPuntoMedicion(latlng) {
            if (!modoMedir || !mapInstance) return;
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            puntosMedicion.push(latlng);
            
            var marcador = L.circleMarker([latlng.lat, latlng.lng], {
                radius: 6,
                color: '#9b59b6',
                fillColor: '#9b59b6',
                fillOpacity: 1,
                weight: 2
            }).addTo(medicionLayer);
            
            marcador.bindTooltip('Punto ' + puntosMedicion.length, {permanent: false, direction: 'top'});
            marcadoresMedicion.push(marcador);
            
            if (puntosMedicion.length >= 2) {
                if (lineaMedicion) {
                    medicionLayer.removeLayer(lineaMedicion);
                }
                
                var coords = puntosMedicion.map(function(p) { return [p.lat, p.lng]; });
                lineaMedicion = L.polyline(coords, {
                    color: '#9b59b6',
                    weight: 3,
                    dashArray: '10, 5'
                }).addTo(medicionLayer);
            }
            
            actualizarPanelDistancia();
        }
        
        function limpiarMedicion() {
            if (medicionLayer) {
                medicionLayer.clearLayers();
            }
            puntosMedicion = [];
            marcadoresMedicion = [];
            lineaMedicion = null;
            document.getElementById('distance-display').textContent = '0 m';
            document.getElementById('distance-points').textContent = 'Puntos: 0';
            if (modoMedir) {
                actualizarStatus('Medicion limpiada. Haga clic para comenzar de nuevo.');
            }
        }
        
        function cerrarMedicion() {
            modoMedir = false;
            if (medicionLayer) {
                medicionLayer.clearLayers();
            }
            puntosMedicion = [];
            marcadoresMedicion = [];
            lineaMedicion = null;
            document.getElementById('btn-medir').classList.remove('active');
            document.getElementById('distance-panel').classList.remove('show');
            document.getElementById('distance-display').textContent = '0 m';
            document.getElementById('distance-points').textContent = 'Puntos: 0';
            
            if (mapInstance) {
                var panes = mapInstance.getPanes();
                if (panes.markerPane) {
                    panes.markerPane.style.pointerEvents = 'auto';
                }
                if (panes.overlayPane) {
                    panes.overlayPane.style.pointerEvents = 'auto';
                }
                if (panes.shadowPane) {
                    panes.shadowPane.style.pointerEvents = 'auto';
                }
                if (panes.popupPane) {
                    panes.popupPane.style.pointerEvents = 'auto';
                }
                if (panes.tooltipPane) {
                    panes.tooltipPane.style.pointerEvents = 'auto';
                }
            }
            
            actualizarStatus('Modo medicion cerrado.');
        }
        
        function abrirModalExportar() {
            document.getElementById('modal-exportar').classList.add('show');
        }
        
        function cerrarModalExportar() {
            document.getElementById('modal-exportar').classList.remove('show');
        }
        
        function exportarMapa(formato) {
            actualizarStatus('Exportando mapa a ' + formato.toUpperCase() + '...');
            cerrarModalExportar();
            
            fetch('/api/export/' + formato)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al exportar');
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'mapa_exportado.' + formato;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                actualizarStatus('Mapa exportado exitosamente como ' + formato.toUpperCase());
            })
            .catch(err => {
                actualizarStatus('Error al exportar: ' + err.message);
                alert('Error al exportar el mapa. Intente de nuevo.');
            });
        }
        
        function exportarRadioBTS() {
            actualizarStatus('Exportando Radio BTS a Excel...');
            cerrarModalExportar();
            
            fetch('/api/export/radio-bts-excel')
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.mensaje || 'Error al exportar');
                    });
                }
                return response.blob();
            })
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'radio_bts_coordenadas.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                actualizarStatus('Radio BTS exportadas exitosamente a Excel');
            })
            .catch(err => {
                actualizarStatus('Error al exportar: ' + err.message);
                alert(err.message);
            });
        }
        
        var originalManejarClickMapa = manejarClickMapa;
        manejarClickMapa = function(latlng) {
            if (modoMedir) {
                agregarPuntoMedicion(latlng);
                return;
            }
            originalManejarClickMapa(latlng);
        };
    </script>
</body>
</html>
