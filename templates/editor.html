<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Mapa de Inteligencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        body.toolbar-collapsed #map-container {
            right: 40px;
        }
        
        body.toolbar-collapsed #toolbar {
            width: 40px;
            overflow: hidden;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-content {
            display: none;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            height: auto;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-header h2 {
            font-size: 0.9em;
            margin: 0;
        }
        
        body.toolbar-collapsed #toolbar .toolbar-header small {
            display: none;
        }
        
        body.toolbar-collapsed #status-bar {
            right: 40px;
        }
        
        body.toolbar-collapsed #toggle-toolbar {
            right: 5px;
        }
        
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 300px;
            bottom: 0;
            transition: right 0.3s ease;
        }
        
        #map-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        #toolbar {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            transition: width 0.3s ease;
        }
        
        #toggle-toolbar {
            position: fixed;
            top: 10px;
            right: 310px;
            z-index: 1001;
            background: #3498db;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: right 0.3s ease;
        }
        
        #toggle-toolbar:hover {
            background: #2980b9;
        }
        
        .toolbar-header {
            background: #1a252f;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            cursor: pointer;
        }
        
        .toolbar-header h2 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        .toolbar-section {
            padding: 15px;
            border-bottom: 1px solid #34495e;
        }
        
        .toolbar-section h3 {
            font-size: 0.95em;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .tool-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .tool-btn.primary {
            background: #3498db;
            color: white;
        }
        
        .tool-btn.primary:hover {
            background: #2980b9;
        }
        
        .tool-btn.primary.active {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        .tool-btn.secondary {
            background: #7f8c8d;
            color: white;
        }
        
        .tool-btn.secondary:hover {
            background: #6c7a7b;
        }
        
        .tool-btn.danger {
            background: #e74c3c;
            color: white;
        }
        
        .tool-btn.danger:hover {
            background: #c0392b;
        }
        
        .tool-btn.success {
            background: #27ae60;
            color: white;
        }
        
        .tool-btn.success:hover {
            background: #219a52;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            font-size: 0.85em;
            margin-bottom: 5px;
            color: #bdc3c7;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .color-input {
            height: 35px;
            cursor: pointer;
        }
        
        #elementos-lista {
            max-height: 200px;
            overflow-y: auto;
            background: #34495e;
            border-radius: 6px;
            padding: 5px;
        }
        
        .elemento-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 3px 0;
            background: #2c3e50;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .elemento-item .elem-nombre {
            flex: 1;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .elemento-item .elem-nombre:hover {
            background: #34495e;
        }
        
        .elemento-item .elem-actions {
            display: flex;
            gap: 5px;
        }
        
        .elemento-item .action-btn {
            background: #7f8c8d;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
        }
        
        .elemento-item .action-btn.edit-btn:hover {
            background: #3498db;
        }
        
        .elemento-item .action-btn.delete-btn {
            background: #e74c3c;
        }
        
        .elemento-item .action-btn.delete-btn:hover {
            background: #c0392b;
        }
        
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 300px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 10px 20px;
            font-size: 0.9em;
            transition: right 0.3s ease;
        }
        
        .hidden {
            display: none !important;
        }
        
        #instrucciones {
            background: #1a252f;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85em;
            line-height: 1.5;
            color: #bdc3c7;
        }
        
        #modal-rename, #modal-tipo-elemento, #modal-editar-torre {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        #modal-rename.show, #modal-tipo-elemento.show, #modal-editar-torre.show {
            display: flex;
        }
        
        .modal-content {
            background: #2c3e50;
            padding: 25px;
            border-radius: 10px;
            min-width: 350px;
            color: white;
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #3498db;
        }
        
        .modal-content input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 1em;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .modal-buttons .btn-save {
            background: #27ae60;
            color: white;
        }
        
        .modal-buttons .btn-cancel {
            background: #7f8c8d;
            color: white;
        }
        
        .tipo-elemento-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            text-align: left;
            transition: all 0.2s;
        }
        
        .tipo-elemento-btn:hover {
            transform: translateX(5px);
        }
        
        .tipo-torre { background: #e74c3c; color: white; }
        .tipo-encuentro { background: #27ae60; color: white; }
        .tipo-focus { background: #f39c12; color: white; }
        .tipo-normal { background: #3498db; color: white; }
        
        #radio-torre-group {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #34495e;
            border-radius: 6px;
        }
        
        #radio-torre-group label {
            display: block;
            margin-bottom: 5px;
            color: #bdc3c7;
        }
        
        #radio-torre-group input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <button id="toggle-toolbar" onclick="toggleToolbar()" title="Ocultar/Mostrar herramientas">&#10005;</button>
    
    <div id="map-container">
        <iframe id="map-frame" srcdoc="{{ mapa_contenido | e }}"></iframe>
    </div>
    
    <div id="toolbar">
        <div class="toolbar-header" onclick="toggleToolbar()">
            <h2>Editor de Mapa</h2>
            <small>Herramientas de Inteligencia</small>
        </div>
        
        <div class="toolbar-content">
            <div class="toolbar-section">
                <h3>Ir a Coordenadas</h3>
                <div class="input-group">
                    <label>Coordenadas (lat, lon):</label>
                    <input type="text" id="coordenadas-input" placeholder="9.7489, -69.5839">
                </div>
                <button class="tool-btn primary" onclick="irACoordenadas()">
                    Ir a Coordenadas
                </button>
            </div>
            
            <div class="toolbar-section">
                <h3>Herramientas de Dibujo</h3>
                <button class="tool-btn primary" id="btn-ruta" onclick="activarModo('ruta')">
                    Dibujar Ruta
                </button>
                <button class="tool-btn primary" id="btn-etiqueta" onclick="activarModo('etiqueta')">
                    Agregar Etiqueta
                </button>
                <button class="tool-btn primary" id="btn-circulo" onclick="activarModo('circulo')">
                    Agregar Circulo
                </button>
                <button class="tool-btn secondary" id="btn-cancelar" onclick="cancelarModo()">
                    Cancelar Dibujo
                </button>
            </div>
            
            <div class="toolbar-section">
                <h3>Opciones</h3>
                <div class="input-group">
                    <label>Color:</label>
                    <input type="color" id="color-selector" class="color-input" value="#FF0000">
                </div>
                <div class="input-group">
                    <label>Texto/Nombre:</label>
                    <input type="text" id="texto-input" placeholder="Nombre del elemento">
                </div>
                <div class="input-group" id="radio-group">
                    <label>Radio (metros):</label>
                    <input type="number" id="radio-input" value="100" min="10" max="10000">
                </div>
                <div class="input-group" id="grosor-group">
                    <label>Grosor de linea:</label>
                    <input type="number" id="grosor-input" value="3" min="1" max="20">
                </div>
            </div>
            
            <div class="toolbar-section">
                <h3>Acciones</h3>
                <button class="tool-btn secondary" onclick="deshacer()">
                    Deshacer Ultimo
                </button>
                <button class="tool-btn danger" onclick="limpiarTodo()">
                    Limpiar Todo
                </button>
                <button class="tool-btn success" onclick="guardarMapa()">
                    Guardar Mapa
                </button>
            </div>
            
            <div class="toolbar-section">
                <h3>Elementos Agregados</h3>
                <div id="elementos-lista"></div>
            </div>
            
            <div class="toolbar-section">
                <div id="instrucciones">
                    <strong>Instrucciones:</strong><br>
                    1. Seleccione una herramienta<br>
                    2. Haga clic en el mapa<br>
                    3. Para rutas: doble clic para terminar<br>
                    4. Click en nombre para renombrar<br>
                    5. Guarde los cambios al finalizar
                </div>
            </div>
        </div>
    </div>
    
    <div id="status-bar">
        Listo. Seleccione una herramienta para comenzar.
    </div>
    
    <div id="modal-rename">
        <div class="modal-content">
            <h3>Renombrar Elemento</h3>
            <input type="text" id="rename-input" placeholder="Nuevo nombre">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cerrarModalRename()">Cancelar</button>
                <button class="btn-save" onclick="guardarRename()">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-editar-torre">
        <div class="modal-content">
            <h3>Editar Torre Telefonica</h3>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Nombre de la Antena:</label>
                <input type="text" id="editar-nombre-torre" placeholder="Nombre de la torre" style="width:100%;padding:8px;border:none;border-radius:4px;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Radio en metros:</label>
                <input type="number" id="editar-radio-torre" min="50" max="10000" style="width:100%;padding:8px;border:none;border-radius:4px;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Color del radio:</label>
                <input type="color" id="editar-color-torre" style="width:100%;height:35px;border:none;border-radius:4px;cursor:pointer;">
            </div>
            <div style="margin-bottom:10px;">
                <label style="display:block;margin-bottom:5px;color:#bdc3c7;">Grosor de linea:</label>
                <input type="number" id="editar-grosor-torre" min="1" max="10" style="width:100%;padding:8px;border:none;border-radius:4px;">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cerrarModalEditarTorre()">Cancelar</button>
                <button class="btn-save" onclick="guardarEditarTorre()">Guardar</button>
            </div>
        </div>
    </div>
    
    <div id="modal-tipo-elemento">
        <div class="modal-content">
            <h3>Seleccione Tipo de Elemento</h3>
            <p style="color:#bdc3c7;margin-bottom:15px;" id="coordenadas-mostrar"></p>
            <button class="tipo-elemento-btn tipo-torre" onclick="seleccionarTipoElemento('torre')">
                Torre Telefonica
            </button>
            <button class="tipo-elemento-btn tipo-encuentro" onclick="seleccionarTipoElemento('encuentro')">
                Punto de Encuentro
            </button>
            <button class="tipo-elemento-btn tipo-focus" onclick="seleccionarTipoElemento('focus')">
                Focus
            </button>
            <button class="tipo-elemento-btn tipo-normal" onclick="seleccionarTipoElemento('normal')">
                Marcador Normal
            </button>
            <div id="radio-torre-group">
                <div style="margin-bottom:10px;">
                    <label>Nombre de la Antena:</label>
                    <input type="text" id="nombre-torre-input" placeholder="Ej: Torre Central" style="width:100%;padding:8px;border:none;border-radius:4px;margin-top:5px;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>Radio en metros:</label>
                    <input type="number" id="radio-torre-input" value="500" min="50" max="10000" style="width:100%;padding:8px;border:none;border-radius:4px;margin-top:5px;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>Color del radio:</label>
                    <input type="color" id="color-torre-input" value="#e74c3c" style="width:100%;height:35px;border:none;border-radius:4px;margin-top:5px;cursor:pointer;">
                </div>
                <div style="margin-bottom:10px;">
                    <label>Grosor de linea:</label>
                    <input type="number" id="grosor-torre-input" value="2" min="1" max="10" style="width:100%;padding:8px;border:none;border-radius:4px;margin-top:5px;">
                </div>
                <button class="tool-btn success" style="margin-top:10px;" onclick="confirmarTorre()">
                    Agregar Torre
                </button>
            </div>
            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn-cancel" onclick="cerrarModalTipo()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        var modoActual = null;
        var puntosRuta = [];
        var elementosEnMapa = [];
        var mapInstance = null;
        var rutaTemp = null;
        var elementosLayer = null;
        var elementoRenombrando = null;
        var coordenadasPendientes = null;
        var torreEditando = null;
        
        var elementosIniciales = {{ elementos | safe }};
        
        function toggleToolbar() {
            document.body.classList.toggle('toolbar-collapsed');
            var btn = document.getElementById('toggle-toolbar');
            if (document.body.classList.contains('toolbar-collapsed')) {
                btn.style.right = '5px';
                btn.innerHTML = '&#9776;';
            } else {
                btn.style.right = '310px';
                btn.innerHTML = '&#10005;';
            }
        }
        
        document.getElementById('map-frame').onload = function() {
            var iframe = document.getElementById('map-frame');
            var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            setTimeout(function() {
                var iframeWindow = iframe.contentWindow;
                for (var key in iframeWindow) {
                    try {
                        if (iframeWindow[key] && iframeWindow[key] instanceof iframeWindow.L.Map) {
                            mapInstance = iframeWindow[key];
                            break;
                        }
                    } catch(e) {}
                }
                
                if (mapInstance) {
                    elementosLayer = iframeWindow.L.layerGroup().addTo(mapInstance);
                    
                    mapInstance.on('click', function(e) {
                        manejarClickMapa(e.latlng);
                    });
                    
                    mapInstance.on('dblclick', function(e) {
                        if (modoActual === 'ruta' && puntosRuta.length >= 2) {
                            finalizarRuta();
                        }
                    });
                    
                    elementosIniciales.forEach(function(elem) {
                        dibujarElementoEnMapa(elem);
                        elementosEnMapa.push(elem);
                    });
                    actualizarListaElementos();
                    
                    hacerControlPlegable(iframeDoc);
                    
                    actualizarStatus('Mapa cargado correctamente.');
                } else {
                    actualizarStatus('Error: No se pudo conectar con el mapa.');
                }
            }, 1000);
        };
        
        function hacerControlPlegable(iframeDoc) {
            function intentar() {
                var controlRadio = iframeDoc.getElementById('control-radio');
                if (controlRadio && !controlRadio.querySelector('.toggle-banner-btn')) {
                    var toggleBtn = iframeDoc.createElement('button');
                    toggleBtn.className = 'toggle-banner-btn';
                    toggleBtn.innerHTML = '&#9650;';
                    toggleBtn.style.cssText = 'background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;margin-left:15px;font-size:0.8em;';
                    toggleBtn.title = 'Ocultar/Mostrar panel';
                    
                    var elementosOcultar = [];
                    Array.from(controlRadio.children).forEach(function(child) {
                        if (child.tagName !== 'H3') {
                            elementosOcultar.push(child);
                        }
                    });
                    
                    toggleBtn.onclick = function() {
                        var isCollapsed = controlRadio.getAttribute('data-collapsed') === 'true';
                        if (isCollapsed) {
                            controlRadio.style.padding = '10px 20px';
                            elementosOcultar.forEach(function(child) {
                                child.style.display = '';
                            });
                            toggleBtn.innerHTML = '&#9650;';
                            controlRadio.setAttribute('data-collapsed', 'false');
                        } else {
                            controlRadio.style.padding = '5px 15px';
                            elementosOcultar.forEach(function(child) {
                                child.style.display = 'none';
                            });
                            toggleBtn.innerHTML = '&#9660;';
                            controlRadio.setAttribute('data-collapsed', 'true');
                        }
                    };
                    controlRadio.appendChild(toggleBtn);
                } else if (!controlRadio) {
                    setTimeout(intentar, 500);
                }
            }
            intentar();
        }
        
        function activarModo(modo) {
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
            
            if (modoActual === modo) {
                modoActual = null;
                actualizarStatus('Modo cancelado.');
                return;
            }
            
            modoActual = modo;
            puntosRuta = [];
            
            document.getElementById('btn-' + modo).classList.add('active');
            
            if (modo === 'ruta') {
                actualizarStatus('Modo RUTA: Haga clic para agregar puntos. Doble clic para finalizar.');
            } else if (modo === 'etiqueta') {
                actualizarStatus('Modo ETIQUETA: Haga clic donde desea colocar la etiqueta.');
            } else if (modo === 'circulo') {
                actualizarStatus('Modo CIRCULO: Haga clic para colocar el centro del circulo.');
            }
        }
        
        function cancelarModo() {
            modoActual = null;
            puntosRuta = [];
            if (rutaTemp) {
                elementosLayer.removeLayer(rutaTemp);
                rutaTemp = null;
            }
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
            actualizarStatus('Modo cancelado.');
        }
        
        function manejarClickMapa(latlng) {
            if (!modoActual || !mapInstance) return;
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            if (modoActual === 'ruta') {
                puntosRuta.push([latlng.lat, latlng.lng]);
                
                if (rutaTemp) {
                    elementosLayer.removeLayer(rutaTemp);
                }
                
                var color = document.getElementById('color-selector').value;
                var grosor = parseInt(document.getElementById('grosor-input').value);
                
                rutaTemp = L.polyline(puntosRuta, {
                    color: color,
                    weight: grosor,
                    dashArray: '5, 10'
                }).addTo(elementosLayer);
                
                actualizarStatus('Ruta: ' + puntosRuta.length + ' puntos. Doble clic para finalizar.');
                
            } else if (modoActual === 'etiqueta') {
                agregarEtiqueta(latlng.lat, latlng.lng);
                
            } else if (modoActual === 'circulo') {
                agregarCirculo(latlng.lat, latlng.lng);
            }
        }
        
        function finalizarRuta() {
            if (puntosRuta.length < 2) {
                actualizarStatus('La ruta debe tener al menos 2 puntos.');
                return;
            }
            
            var color = document.getElementById('color-selector').value;
            var grosor = parseInt(document.getElementById('grosor-input').value);
            var nombre = document.getElementById('texto-input').value || 'Ruta ' + (elementosEnMapa.length + 1);
            
            fetch('/api/agregar-ruta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    puntos: puntosRuta,
                    color: color,
                    grosor: grosor,
                    nombre: nombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (rutaTemp) {
                        elementosLayer.removeLayer(rutaTemp);
                        rutaTemp = null;
                    }
                    dibujarElementoEnMapa(data.elemento);
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus('Ruta agregada: ' + nombre);
                }
            });
            
            puntosRuta = [];
            modoActual = null;
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
        }
        
        function agregarEtiqueta(lat, lon) {
            var texto = document.getElementById('texto-input').value || 'Etiqueta';
            var color = document.getElementById('color-selector').value;
            
            fetch('/api/agregar-etiqueta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    texto: texto,
                    color: color
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dibujarElementoEnMapa(data.elemento);
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus('Etiqueta agregada: ' + texto);
                }
            });
            
            modoActual = null;
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
        }
        
        function agregarCirculo(lat, lon) {
            var radio = parseInt(document.getElementById('radio-input').value);
            var color = document.getElementById('color-selector').value;
            var nombre = document.getElementById('texto-input').value || 'Circulo';
            
            fetch('/api/agregar-circulo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    radio: radio,
                    color: color,
                    nombre: nombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dibujarElementoEnMapa(data.elemento);
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus('Circulo agregado: ' + nombre);
                }
            });
            
            modoActual = null;
            document.querySelectorAll('.tool-btn.primary').forEach(btn => btn.classList.remove('active'));
        }
        
        function dibujarElementoEnMapa(elemento) {
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            
            var layer = null;
            
            if (elemento.tipo === 'ruta') {
                layer = L.polyline(elemento.puntos, {
                    color: elemento.color,
                    weight: elemento.grosor
                }).addTo(elementosLayer);
                layer.bindPopup(elemento.nombre);
                
            } else if (elemento.tipo === 'etiqueta') {
                layer = L.marker([elemento.lat, elemento.lon]).addTo(elementosLayer);
                layer.bindPopup(elemento.texto);
                
            } else if (elemento.tipo === 'torre') {
                var color = elemento.color || '#e74c3c';
                var grosor = elemento.grosor || 2;
                
                var icono = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:' + color + ';color:white;padding:5px 10px;border-radius:50%;font-weight:bold;font-size:14px;text-align:center;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">T</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                var marker = L.marker([elemento.lat, elemento.lon], {icon: icono}).addTo(elementosLayer);
                marker.bindPopup('<b>' + elemento.nombre + '</b><br>Radio: ' + elemento.radio + 'm');
                elemento._marker = marker;
                
                layer = L.circle([elemento.lat, elemento.lon], {
                    radius: elemento.radio,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.15,
                    weight: grosor
                }).addTo(elementosLayer);
                layer.bindPopup(elemento.nombre);
                
            } else if (elemento.tipo === 'circulo') {
                layer = L.circle([elemento.lat, elemento.lon], {
                    radius: elemento.radio,
                    color: elemento.color,
                    fillOpacity: 0.2
                }).addTo(elementosLayer);
                layer.bindPopup(elemento.nombre);
            }
            
            if (layer) {
                elemento._layer = layer;
            }
        }
        
        function eliminarElemento(id) {
            fetch('/api/eliminar-elemento/' + id, {method: 'DELETE'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var elem = elementosEnMapa.find(e => e.id === id);
                    if (elem) {
                        if (elem._layer) {
                            elementosLayer.removeLayer(elem._layer);
                        }
                        if (elem._marker) {
                            elementosLayer.removeLayer(elem._marker);
                        }
                    }
                    elementosEnMapa = elementosEnMapa.filter(e => e.id !== id);
                    actualizarListaElementos();
                    actualizarStatus('Elemento eliminado.');
                }
            });
        }
        
        function abrirModalRename(id) {
            var elem = elementosEnMapa.find(e => e.id === id);
            if (!elem) return;
            
            elementoRenombrando = elem;
            var nombreActual = elem.nombre || elem.texto || '';
            document.getElementById('rename-input').value = nombreActual;
            document.getElementById('modal-rename').classList.add('show');
            document.getElementById('rename-input').focus();
        }
        
        function cerrarModalRename() {
            document.getElementById('modal-rename').classList.remove('show');
            elementoRenombrando = null;
        }
        
        function guardarRename() {
            if (!elementoRenombrando) return;
            
            var nuevoNombre = document.getElementById('rename-input').value.trim();
            if (!nuevoNombre) {
                alert('El nombre no puede estar vacio');
                return;
            }
            
            var elemId = elementoRenombrando.id;
            
            fetch('/api/actualizar-elemento/' + elemId, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nombre: nuevoNombre,
                    texto: nuevoNombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var elem = elementosEnMapa.find(e => e.id === elemId);
                    if (elem) {
                        if (elem.tipo === 'etiqueta') {
                            elem.texto = nuevoNombre;
                        } else {
                            elem.nombre = nuevoNombre;
                        }
                        
                        if (elem._layer && elem._layer.getPopup()) {
                            elem._layer.setPopupContent(nuevoNombre);
                        } else if (elem._layer) {
                            elem._layer.bindPopup(nuevoNombre);
                        }
                    }
                    
                    actualizarListaElementos();
                    actualizarStatus('Elemento renombrado: ' + nuevoNombre);
                    cerrarModalRename();
                } else {
                    alert('Error al renombrar: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(function(err) {
                alert('Error de conexion');
            });
        }
        
        document.getElementById('rename-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                guardarRename();
            }
        });
        
        function deshacer() {
            fetch('/api/deshacer', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var ultimo = elementosEnMapa.pop();
                    if (ultimo && ultimo._layer) {
                        elementosLayer.removeLayer(ultimo._layer);
                    }
                    actualizarListaElementos();
                    actualizarStatus('Ultimo elemento eliminado.');
                } else {
                    actualizarStatus('No hay elementos para deshacer.');
                }
            });
        }
        
        function limpiarTodo() {
            if (!confirm('Â¿Esta seguro de limpiar todos los elementos agregados?')) return;
            
            fetch('/api/limpiar', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    elementosLayer.clearLayers();
                    elementosEnMapa = [];
                    actualizarListaElementos();
                    actualizarStatus('Todos los elementos eliminados.');
                }
            });
        }
        
        function guardarMapa() {
            actualizarStatus('Guardando mapa...');
            
            fetch('/api/guardar', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarStatus(data.mensaje);
                    alert('Mapa guardado como: ' + data.archivo);
                } else {
                    actualizarStatus('Error al guardar: ' + data.mensaje);
                }
            });
        }
        
        function actualizarListaElementos() {
            var lista = document.getElementById('elementos-lista');
            if (elementosEnMapa.length === 0) {
                lista.innerHTML = '<div style="padding:10px;text-align:center;color:#7f8c8d;">Sin elementos</div>';
                return;
            }
            
            var html = '';
            elementosEnMapa.forEach(function(elem) {
                var icono = elem.tipo === 'ruta' ? '~' : (elem.tipo === 'etiqueta' ? 'A' : (elem.tipo === 'torre' ? 'T' : 'O'));
                var nombre = elem.nombre || elem.texto || 'Elemento';
                var editarFunc = elem.tipo === 'torre' ? 'abrirModalEditarTorre(' + elem.id + ')' : 'abrirModalRename(' + elem.id + ')';
                html += '<div class="elemento-item">' +
                    '<span class="elem-nombre" onclick="' + editarFunc + '" title="Click para editar">[' + icono + '] ' + nombre + '</span>' +
                    '<div class="elem-actions">' +
                    '<button class="action-btn edit-btn" onclick="' + editarFunc + '" title="Editar">&#9998;</button>' +
                    '<button class="action-btn delete-btn" onclick="eliminarElemento(' + elem.id + ')" title="Eliminar">X</button>' +
                    '</div></div>';
            });
            lista.innerHTML = html;
        }
        
        function actualizarStatus(mensaje) {
            document.getElementById('status-bar').textContent = mensaje;
        }
        
        function irACoordenadas() {
            var input = document.getElementById('coordenadas-input').value.trim();
            if (!input) {
                alert('Por favor ingrese las coordenadas');
                return;
            }
            
            var partes = input.split(',');
            if (partes.length !== 2) {
                alert('Formato invalido. Use: latitud, longitud (ej: 9.7489, -69.5839)');
                return;
            }
            
            var lat = parseFloat(partes[0].trim());
            var lon = parseFloat(partes[1].trim());
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Coordenadas invalidas. Use numeros validos.');
                return;
            }
            
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Coordenadas fuera de rango. Latitud: -90 a 90, Longitud: -180 a 180');
                return;
            }
            
            coordenadasPendientes = {lat: lat, lon: lon};
            
            if (mapInstance) {
                mapInstance.setView([lat, lon], 16);
            }
            
            document.getElementById('coordenadas-mostrar').textContent = 'Coordenadas: ' + lat.toFixed(6) + ', ' + lon.toFixed(6);
            document.getElementById('radio-torre-group').style.display = 'none';
            document.getElementById('modal-tipo-elemento').classList.add('show');
        }
        
        function cerrarModalTipo() {
            document.getElementById('modal-tipo-elemento').classList.remove('show');
            document.getElementById('radio-torre-group').style.display = 'none';
            coordenadasPendientes = null;
        }
        
        function seleccionarTipoElemento(tipo) {
            if (!coordenadasPendientes) return;
            
            if (tipo === 'torre') {
                document.getElementById('radio-torre-group').style.display = 'block';
                return;
            }
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            var lat = coordenadasPendientes.lat;
            var lon = coordenadasPendientes.lon;
            var nombre = '';
            var color = '';
            var icono = null;
            
            if (tipo === 'encuentro') {
                nombre = 'Punto de Encuentro';
                color = '#27ae60';
                icono = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#27ae60;color:white;padding:5px 10px;border-radius:50%;font-weight:bold;font-size:16px;text-align:center;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">PE</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            } else if (tipo === 'focus') {
                nombre = 'Focus';
                color = '#f39c12';
                icono = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background:#f39c12;color:white;padding:5px 10px;border-radius:50%;font-weight:bold;font-size:16px;text-align:center;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">F</div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            } else {
                nombre = 'Marcador';
                color = '#3498db';
            }
            
            var marker;
            if (icono) {
                marker = L.marker([lat, lon], {icon: icono}).addTo(elementosLayer);
            } else {
                marker = L.marker([lat, lon]).addTo(elementosLayer);
            }
            marker.bindPopup('<b>' + nombre + '</b><br>Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
            
            fetch('/api/agregar-etiqueta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    texto: nombre,
                    color: color
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.elemento._layer = marker;
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus(nombre + ' agregado en: ' + lat.toFixed(4) + ', ' + lon.toFixed(4));
                }
            });
            
            cerrarModalTipo();
        }
        
        function confirmarTorre() {
            if (!coordenadasPendientes) return;
            
            var nombre = document.getElementById('nombre-torre-input').value.trim() || 'Torre Telefonica';
            var radio = parseInt(document.getElementById('radio-torre-input').value);
            var color = document.getElementById('color-torre-input').value;
            var grosor = parseInt(document.getElementById('grosor-torre-input').value) || 2;
            
            if (isNaN(radio) || radio < 50 || radio > 10000) {
                alert('Radio invalido. Use un valor entre 50 y 10000 metros.');
                return;
            }
            
            var iframe = document.getElementById('map-frame');
            var L = iframe.contentWindow.L;
            var lat = coordenadasPendientes.lat;
            var lon = coordenadasPendientes.lon;
            
            var icono = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background:' + color + ';color:white;padding:5px 10px;border-radius:50%;font-weight:bold;font-size:14px;text-align:center;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);">T</div>',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            
            var marker = L.marker([lat, lon], {icon: icono}).addTo(elementosLayer);
            marker.bindPopup('<b>' + nombre + '</b><br>Radio: ' + radio + 'm<br>Lat: ' + lat.toFixed(6) + '<br>Lon: ' + lon.toFixed(6));
            
            var circle = L.circle([lat, lon], {
                radius: radio,
                color: color,
                fillColor: color,
                fillOpacity: 0.15,
                weight: grosor
            }).addTo(elementosLayer);
            
            fetch('/api/agregar-torre', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    lat: lat,
                    lon: lon,
                    radio: radio,
                    color: color,
                    grosor: grosor,
                    nombre: nombre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.elemento._layer = circle;
                    data.elemento._marker = marker;
                    elementosEnMapa.push(data.elemento);
                    actualizarListaElementos();
                    actualizarStatus(nombre + ' agregada con radio de ' + radio + 'm');
                }
            });
            
            document.getElementById('nombre-torre-input').value = '';
            cerrarModalTipo();
        }
        
        function abrirModalEditarTorre(id) {
            var elem = elementosEnMapa.find(e => e.id === id);
            if (!elem || elem.tipo !== 'torre') {
                abrirModalRename(id);
                return;
            }
            
            torreEditando = elem;
            document.getElementById('editar-nombre-torre').value = elem.nombre || 'Torre Telefonica';
            document.getElementById('editar-radio-torre').value = elem.radio || 500;
            document.getElementById('editar-color-torre').value = elem.color || '#e74c3c';
            document.getElementById('editar-grosor-torre').value = elem.grosor || 2;
            document.getElementById('modal-editar-torre').classList.add('show');
            document.getElementById('editar-nombre-torre').focus();
        }
        
        function cerrarModalEditarTorre() {
            document.getElementById('modal-editar-torre').classList.remove('show');
            torreEditando = null;
        }
        
        function guardarEditarTorre() {
            if (!torreEditando) return;
            
            var nombre = document.getElementById('editar-nombre-torre').value.trim();
            var radio = parseInt(document.getElementById('editar-radio-torre').value);
            var color = document.getElementById('editar-color-torre').value;
            var grosor = parseInt(document.getElementById('editar-grosor-torre').value);
            
            if (!nombre) {
                alert('El nombre no puede estar vacio');
                return;
            }
            
            if (isNaN(radio) || radio < 50 || radio > 10000) {
                alert('Radio invalido. Use un valor entre 50 y 10000 metros.');
                return;
            }
            
            if (isNaN(grosor) || grosor < 1 || grosor > 10) {
                grosor = 2;
            }
            
            var elemId = torreEditando.id;
            
            fetch('/api/actualizar-torre/' + elemId, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nombre: nombre,
                    radio: radio,
                    color: color,
                    grosor: grosor
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var elem = elementosEnMapa.find(e => e.id === elemId);
                    if (elem) {
                        if (elem._layer) {
                            elementosLayer.removeLayer(elem._layer);
                        }
                        if (elem._marker) {
                            elementosLayer.removeLayer(elem._marker);
                        }
                        
                        elem.nombre = nombre;
                        elem.radio = radio;
                        elem.color = color;
                        elem.grosor = grosor;
                        
                        dibujarElementoEnMapa(elem);
                    }
                    
                    actualizarListaElementos();
                    actualizarStatus('Torre actualizada: ' + nombre);
                    cerrarModalEditarTorre();
                } else {
                    alert('Error al actualizar: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(function(err) {
                alert('Error de conexion');
            });
        }
        
        document.getElementById('editar-nombre-torre').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                guardarEditarTorre();
            }
        });
    </script>
</body>
</html>
